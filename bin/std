#!/usr/bin/python3

# Start The Day script
# Copyright (C) 2022-2025 Maxim P. Dementyev <dememax@hotmail.com>

import os, os.path
import stat
import subprocess
import datetime

SCITE_EXE = 'SciTE'

###############################################################
# Working directory
###############################################################

workdir = os.path.expanduser("~/Journal")

if not os.path.exists(workdir):
    print(f"Error! Working directory {workdir} does not exist!")
    exit(10)

# Result: Working directory name is set, the folder exists

###############################################################
# Names: Today directory and its content
###############################################################

if not os.path.isdir(workdir):
    print(f"Error! Working directory {workdir} is not a directory!")
    exit(2)

expected_mode = 'dr-xr-xr-x'
workdirmode = stat.filemode(os.stat(workdir).st_mode)
if workdirmode != expected_mode:
    print(f"Warning! Working directory {workdir} has an unexpected mode: {workdirmode}, expected {expected_mode}")
if workdirmode[0] != 'd':
    print(f"Error! Must be a directory.")
    exit(3)

# Today directory
td = datetime.datetime.today()
today_iso = td.strftime('%Y-%m-%d') # YYYY-MM-DD
todaydir = os.path.join(workdir, today_iso)
notesfile = os.path.join(todaydir, 'Notes.rst')

# Result: all today's names are ready

###############################################################
# Ready to check today's directory
###############################################################

if os.path.exists(todaydir):
    if not os.path.isdir(todaydir):
        print(f"Error! Today's directory {todaydir} is not a directory!")
        exit(4)
else:
    if workdirmode[2] != 'w':
        print(f"Changing working directory {workdir} mode to writable...")
        res = subprocess.run(['chmod', 'u+w', workdir]).returncode
        if res:
            print(f"Error! Cannot make the working directory {workdir} writable")
            exit(5)
    print(f"Creating today's directory {todaydir}...")
    os.mkdir(todaydir) # no check - raises an exception like PermissionError, works like exit(1)

# Result: Today's directory exists with correct access rights.

###############################################################
# Ensure access rights for todaydir
###############################################################

print(f"Making all contents of Journal read-only...")
res = subprocess.run(["chmod", "a-w", "-R", workdir]).returncode
if res:
    print(f"Error! Cannot make the Journal folder read-only! chmod status: {res}. Exiting...")
    exit(9)

print(f"Making today's directory {todaydir} writable for the user...")
res = subprocess.run(["chmod", "u+w", todaydir]).returncode
if res:
    print(f"Error! Cannot make today's directory writable! chmod status: {res}. Exiting...")
    exit(7)

# Result: Today's directory exists with correct access rights; other Journal content is protected.

###############################################################
# Notes file: reStructuredText with a title to be included in contents
###############################################################

if os.path.exists(notesfile):
    if not os.path.isfile(notesfile):
        print(f"Error! Today's notes file {notesfile} is not a file!")
        exit(8)
    print(f"Making the existing today's notes file {notesfile} writable for the user...")
    res = subprocess.run(["chmod", "u+w", notesfile]).returncode
    if res:
        print(f"Error! Cannot make today's notes file writable! chmod status: {res}. Exiting...")
        exit(11)

else:
    print(f"Creating today's notes file {notesfile}...")
    today_iso_weekday = today_iso + ' ' + td.strftime('%H-%M') + ' ' + td.strftime('%A')
    with open(notesfile, 'xt') as nf:
        page_caption_bar = ('#' * len(today_iso_weekday)) + '\n'
        nf.write(page_caption_bar)
        nf.write(today_iso_weekday + '\n')
        nf.write(page_caption_bar)
        nf.write('\n')
        nf.write('*****\n')
        nf.write('Subj\n')
        nf.write('***\n')
        nf.write('\n')
        nf.close()

# Result: Notes file exists with correct access rights.

###############################################################
# Go foreground with a child process: we split and exit the main application (foregraound)
###############################################################

if os.fork():
    # parent: output the result
    print(f'In the parent with PID {os.getpid()} and PPID {os.getppid()}. Exiting, letting the child run {SCITE_EXE} for {notesfile}... ')
    exit(0) # all is ok

###############################################################
# Launch the editor, wait and correct access rights after
###############################################################

print(f'In the child with PID {os.getpid()} and PPID {os.getppid()}. Running the editor {SCITE_EXE} for {notesfile}...')
res = subprocess.run([SCITE_EXE, notesfile]).returncode
print() # force the new line
print(f'Result for {notesfile} is {res}')
print(f'Protecting {todaydir} directory...')
res = subprocess.run(["chmod", "a-w", "-R", todaydir]).returncode
if res:
    print(f"Error! Cannot make the today's folder {todaydir} read-only! Status of chmod {res}. Exiting...")
    exit(6)
print(f'Exiting the child with PID {os.getpid()} and PPID {os.getppid()}. The notes file was {notesfile}...')
exit(res)
