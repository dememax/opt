#!/usr/bin/python3

# Start The Day script
# Copyright (C) 2022 Maxim P. Dementiev <max@e-soft.ru>

import os, os.path
import subprocess
import datetime

SCITE_EXE = 'SciTE'

# Working dir

workdir = os.path.expanduser("~/Journal")

if not os.path.exists(workdir):
    print(f"Error! Working direcotry {workdir} doesn't exist!")
    exit(1)

# Today dir
td = datetime.datetime.today()
today_iso = td.strftime('%Y-%m-%d') # YYYY-MM-DD
todaydir = os.path.join(workdir, today_iso)

if os.path.exists(todaydir):
    if not os.path.isdir(todaydir):
        print(f"Error! Today's direcotry {todaydir} isn't a directory!")
        exit(2)
else:
    print(f"Creating today's direcotry {todaydir}...")
    os.mkdir(todaydir)

# Notes file: reStructuredText with the title for to be included in contents

notesfile = os.path.join(todaydir, 'Notes.rst')

if os.path.exists(notesfile):
    if not os.path.isfile(notesfile):
        print(f"Error! Today's notes file {notesfile} isn't a file!")
        exit(3)
else:
    print(f"Creating today's notes file {notesfile}...")
    today_iso_weekday = today_iso + ' ' + td.strftime('%H-%M') + ' ' + td.strftime('%A')
    with open(notesfile, 'xt') as nf:
        page_caption_bar = ('=' * len(today_iso_weekday)) + '\n'
        nf.write(page_caption_bar)
        nf.write(today_iso_weekday + '\n')
        nf.write(page_caption_bar)
        nf.write('\n')
        nf.write('*****\n')
        nf.write('Subj\n')
        nf.write('***\n')
        nf.write('\n')
        nf.close()

if os.fork():
    # parent: output the result
    print(f'Child is run for {notesfile}.')
    exit(0) # all is ok

# child: lunch the editor on it
print(f'Running editor for {notesfile}...')
res = subprocess.run([SCITE_EXE, notesfile]).returncode
print() # force the new line
print(f'Result for {notesfile} is {res}')
exit(res)
